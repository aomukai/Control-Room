<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Room</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.min.css">
</head>
<body>
    <div id="app">
        <!-- Left Sidebar -->
        <div id="left-sidebar">
            <div class="sidebar-header">Control Room</div>
            <div class="sidebar-buttons">
                <button class="sidebar-btn" id="btn-toggle-mode" title="Switch to Workbench" aria-label="Switch to Workbench">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/arrows-right-left.svg" alt="">
                    </span>
                    <span class="btn-text">Toggle Mode</span>
                </button>
                <!-- Editor-only buttons -->
                <button class="sidebar-btn" id="btn-toggle-explorer" title="Toggle Explorer" aria-label="Toggle Explorer">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/rectangle-stack.svg" alt="">
                    </span>
                    <span class="btn-text">Explorer</span>
                </button>
                <button class="sidebar-btn" id="btn-open-workspace" title="Open File System" aria-label="Open File System">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/folder-open.svg" alt="">
                    </span>
                    <span class="btn-text">File System</span>
                </button>
                <button class="sidebar-btn" id="btn-sidebar-search" title="Search in Project" aria-label="Search in Project">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/magnifying-glass.svg" alt="">
                    </span>
                    <span class="btn-text">Search</span>
                </button>
                <button class="sidebar-btn" id="btn-commit" title="Create a New Local Version" aria-label="Create a New Local Version">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/arrow-path-rounded-square.svg" alt="">
                    </span>
                    <span class="btn-text">Versioning</span>
                </button>
                <button class="sidebar-btn" id="btn-open-terminal" title="Open Terminal Here" aria-label="Open Terminal Here">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/command-line.svg" alt="">
                    </span>
                    <span class="btn-text">Terminal</span>
                </button>
                <!-- Workbench-only buttons -->
                <button class="sidebar-btn" id="btn-sidebar-issues" title="Issues" aria-label="Issues">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/rectangle-stack.svg" alt="">
                    </span>
                    <span class="btn-text">Issues</span>
                </button>
                <button class="sidebar-btn" id="btn-sidebar-widgets" title="Widgets" aria-label="Widgets">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/swatch.svg" alt="">
                    </span>
                    <span class="btn-text">Widgets</span>
                </button>
                <button class="sidebar-btn" id="btn-sidebar-patch-review" title="Patch Review" aria-label="Patch Review">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/pencil-square.svg" alt="">
                    </span>
                    <span class="btn-text">Patch Review</span>
                </button>
            </div>
            <div id="file-tree-area">
                <div class="sidebar-divider"></div>
                <div class="file-tree-header">
                    Files
                    <div class="tree-actions">
                        <button class="tree-action-btn" id="btn-new-file" title="New File" aria-label="New File">
                            <span class="btn-icon">
                                <img src="assets/icons/heroicons_outline/document-plus.svg" alt="">
                            </span>
                        </button>
                        <button class="tree-action-btn" id="btn-new-folder" title="New Folder" aria-label="New Folder">
                            <span class="btn-icon">
                                <img src="assets/icons/heroicons_outline/folder-plus.svg" alt="">
                            </span>
                        </button>
                        <button class="tree-action-btn" id="btn-refresh-tree" title="Refresh" aria-label="Refresh">
                            <span class="btn-icon">
                                <img src="assets/icons/heroicons_outline/arrow-path.svg" alt="">
                            </span>
                        </button>
                    </div>
                </div>
                <div id="file-tree"></div>
            </div>
            <div class="sidebar-footer">
                <button class="sidebar-btn" id="btn-workspace-switch" title="Switch Project" aria-label="Switch Project">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/server.svg" alt="">
                    </span>
                    <span class="btn-text" id="workspace-name">Project</span>
                </button>
                <button class="sidebar-btn" id="btn-dev-tools" title="Dev Tools" aria-label="Dev Tools">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/cloud.svg" alt="">
                    </span>
                    <span class="btn-text">Dev Tools</span>
                </button>
                <button class="sidebar-btn" id="btn-open-settings" title="Settings" aria-label="Settings">
                    <span class="btn-icon">
                        <img src="assets/icons/heroicons_outline/cog-6-tooth.svg" alt="">
                    </span>
                    <span class="btn-text">Settings</span>
                </button>
            </div>
        </div>
        <!-- Main Container -->
        <div id="main-container">
            <!-- View Container (Editor or Workbench) -->
            <div id="view-container">
                <!-- Editor View (existing) -->
                <div id="editor-view" class="view-panel active">
                    <!-- Horizontal Split: Main Area and Chat Panel -->
                    <div id="main-split">
                <!-- Center Area (Editor + Bottom Console) -->
                <div id="center-area">
                    <!-- Top Tab Strip -->
                    <div id="tab-strip">
                        <div class="tab-strip-label">file Navigation (open files tabs)</div>
                        <div id="tabs-container"></div>
                        <div class="tab-strip-actions">
                            <button class="tab-action-btn" id="btn-find" title="Find in File (Ctrl+F)" disabled aria-label="Find in File (Ctrl+F)">
                                <span class="btn-icon">üîç</span>
                                <span class="btn-text">Find</span>
                            </button>
                            <button class="tab-action-btn" id="btn-search" title="Search in Project (Ctrl+Shift+F)" aria-label="Search in Project (Ctrl+Shift+F)">
                                <span class="btn-icon">üîé</span>
                                <span class="btn-text">Search</span>
                            </button>
                            <button class="tab-action-btn" id="btn-create-issue" title="Create Issue" aria-label="Create Issue">
                                <span class="btn-icon">+</span>
                                <span class="btn-text">New Issue</span>
                            </button>
                            <button class="tab-action-btn" id="btn-reveal-file" title="Reveal File in Explorer" disabled>
                                <span class="btn-icon">üìç</span>
                                <span class="btn-text">Reveal File</span>
                            </button>
                            <button class="tab-action-btn" id="btn-open-folder" title="Open Containing Folder" disabled>
                                <span class="btn-icon">üìÇ</span>
                                <span class="btn-text">Open Folder</span>
                            </button>
                        </div>
                    </div>

                    <!-- Vertical Split: Editor and Console -->
                    <div id="editor-console-split">
                        <!-- Editor Area -->
                        <div id="editor-area">
                            <div id="editor-placeholder">
                                <div class="placeholder-text">
                                    <h2>Welcome to Control Room</h2>
                                    <p>Select a file from the sidebar to start editing</p>
                                    <p class="shortcut">Ctrl+S to save</p>
                                </div>
                            </div>
                            <div id="monaco-editor"></div>
                        </div>

                        <!-- Bottom Console -->
                        <div id="bottom-console">
                            <div class="console-tabs">
                                <button class="console-tab active" data-tab="console">Console</button>
                                <button class="console-tab" data-tab="ai-actions">AI Actions</button>
                                <button class="console-tab" data-tab="search">Search</button>
                            </div>
                            <div class="console-content">
                                <!-- Console Tab -->
                                <div id="console-panel" class="console-panel active">
                                    <div id="console-output"></div>
                                </div>

                                <!-- AI Actions Tab -->
                                <div id="ai-actions-panel" class="console-panel">
                                    <div class="ai-actions-header">Proposed Changes</div>
                                    <div id="ai-actions-list">
                                        <div class="ai-action-item">
                                            <div class="ai-action-info">
                                                <span class="ai-action-file">scenes/intro.md</span>
                                                <span class="ai-action-desc">Add more sensory details to the coffee shop scene</span>
                                            </div>
                                            <div class="ai-action-buttons">
                                                <button class="ai-action-btn preview" data-action="preview-1">Preview</button>
                                                <button class="ai-action-btn apply" data-action="apply-1">Apply</button>
                                                <button class="ai-action-btn reject" data-action="reject-1">Reject</button>
                                            </div>
                                        </div>
                                        <div class="ai-action-item">
                                            <div class="ai-action-info">
                                                <span class="ai-action-file">chars/mara.md</span>
                                                <span class="ai-action-desc">Expand character backstory section</span>
                                            </div>
                                            <div class="ai-action-buttons">
                                                <button class="ai-action-btn preview" data-action="preview-2">Preview</button>
                                                <button class="ai-action-btn apply" data-action="apply-2">Apply</button>
                                                <button class="ai-action-btn reject" data-action="reject-2">Reject</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="diff-preview" class="hidden">
                                        <div class="diff-header">
                                            <span>Diff Preview</span>
                                            <button id="close-diff">√ó</button>
                                        </div>
                                        <pre id="diff-content"></pre>
                                    </div>
                                </div>

                                <!-- Search Tab -->
                                <div id="search-panel" class="console-panel">
                                    <div class="search-input-container">
                                        <input type="text" id="search-input" placeholder="Search in Project...">
                                        <button id="search-btn">Search</button>
                                    </div>
                                    <div id="search-results"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Bar -->
                    <div id="status-bar">
                        <div id="status-left">
                            <span id="status-text">Ready</span>
                            <button id="status-alert" class="hidden" type="button"></button>
                        </div>
                        <div id="status-right">
                            <button id="notification-bell" type="button" title="Notifications">Bell</button>
                            <span id="notification-count" class="hidden">0</span>
                        </div>
                    </div>
                </div>

                <!-- Right Chat Panel -->
                <div id="chat-panel">
                    <div class="chat-header">
                        <span class="chat-title">Chat with AI</span>
                        <div class="chat-header-actions">
                            <select id="agent-select" title="Agent" aria-label="Agent">
                                <option value="">Loading agents...</option>
                            </select>
                        </div>
                    </div>
                    <div class="chat-meta-bar">
                        <input id="chat-memory-id" type="text" placeholder="Memory ID (optional)" aria-label="Memory ID">
                        <button id="chat-memory-set" type="button">Bind</button>
                        <span id="chat-memory-badge" class="chat-badge hidden" title="Current memory level">R3</span>
                        <button id="chat-escalate" type="button" class="chat-escalate-btn" title="Fetch more evidence">More evidence</button>
                    </div>
                    <div id="chat-history"></div>
                    <div class="chat-input-container">
                        <textarea id="chat-input" placeholder="Ask the AI assistant..."></textarea>
                        <button id="chat-send">Send</button>
                    </div>
                </div>
                    </div>
                </div>
                <!-- End Editor View -->

                <!-- Workbench View -->
                <div id="workbench-view" class="view-panel">
                    <div id="workbench-layout">
                        <!-- Agent Sidebar -->
                            <div id="workbench-agent-sidebar">
                            <div class="workbench-panel-header">
                                <span class="panel-title">Agents</span>
                                <div class="panel-action-group">
                                    <button id="btn-add-agent" class="panel-action-btn" title="Add Agent">+</button>
                                    <button id="btn-import-agent" class="panel-action-btn" title="Import Agent">v</button>
                                </div>
                            </div>
                            <div class="workbench-agent-actions">
                                <button id="btn-start-conference" class="panel-action-primary" type="button">
                                    Start Conference
                                </button>
                            </div>
                            <div id="agent-list" class="agent-list">
                                <!-- Will be populated by JS -->
                            </div>
                            <div class="workbench-agent-footer">
                                <button id="btn-retired-agents" class="panel-action-btn" title="Nursing Home" aria-label="Nursing Home">
                                    Nursing Home
                                </button>
                            </div>
                        </div>

                        <!-- Issue Board Pane -->
                        <div id="workbench-chat-pane">
                            <div id="workbench-chat-content">
                                <!-- Issue Board rendered by JS -->
                            </div>
                        </div>

                        <!-- Newsfeed Panel -->
                        <div id="workbench-newsfeed">
                            <div class="workbench-panel-header">
                                <span class="panel-title">Newsfeed</span>
                            </div>
                            <div id="newsfeed-list">
                                <!-- Will be populated by JS from NotificationStore -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Workbench View -->

                <!-- Settings View (placeholder) -->
                <div id="settings-view" class="view-panel">
                    <div id="settings-content">
                        <div class="settings-section">
                            <h2>Memory Moderator</h2>
                            <p class="settings-hint">Promote/rollback, pin minimum level, or archive memory items.</p>
                            <div class="settings-row">
                                <label for="moderator-memory-id">Memory ID</label>
                                <input id="moderator-memory-id" type="text" placeholder="mem-1">
                            </div>
                            <div class="settings-row">
                                <label for="moderator-version-id">Version ID</label>
                                <input id="moderator-version-id" type="text" placeholder="ver-1">
                            </div>
                            <div class="settings-actions">
                                <button id="btn-promote-memory" type="button">Promote / Set Active</button>
                                <button id="btn-pin-memory" type="button">Pin at R3</button>
                                <button id="btn-archive-memory" type="button">Archive</button>
                            </div>
                            <div class="settings-row">
                                <label for="decay-archive-days">Archive after (days)</label>
                                <input id="decay-archive-days" type="number" min="1" value="14">
                            </div>
                            <div class="settings-row">
                                <label for="decay-expire-days">Expire after (days)</label>
                                <input id="decay-expire-days" type="number" min="1" value="30">
                            </div>
                            <div class="settings-row">
                                <label for="decay-interval-min">Interval (minutes)</label>
                                <input id="decay-interval-min" type="number" min="10" value="360">
                            </div>
                            <div class="settings-row">
                                <label for="decay-prune-r5">Prune expired R5</label>
                                <input id="decay-prune-r5" type="checkbox" aria-label="Prune expired R5 evidence">
                            </div>
                            <div class="settings-row">
                                <label for="decay-notify-on-run">Notify on run</label>
                                <input id="decay-notify-on-run" type="checkbox" aria-label="Notify on run" checked>
                            </div>
                            <div class="settings-row">
                                <label for="decay-exclude-topics">Exclude topic keys (comma or newline)</label>
                                <textarea id="decay-exclude-topics" rows="2" placeholder="epoch-123, onboarding, sprint-42" aria-label="Exclude topic keys"></textarea>
                            </div>
                            <div class="settings-row">
                                <label for="decay-exclude-agents">Exclude agent IDs (comma or newline)</label>
                                <textarea id="decay-exclude-agents" rows="2" placeholder="agent-1, agent-ops" aria-label="Exclude agent IDs"></textarea>
                            </div>
                            <div class="settings-actions">
                                <button id="btn-save-decay-config" type="button" class="primary">Save Decay Config</button>
                                <button id="btn-run-decay" type="button">Run Decay / Compression</button>
                                <button id="btn-download-decay-report" type="button">Dry Run Report</button>
                                <label class="settings-toggle">
                                    <input id="decay-dry-run" type="checkbox" aria-label="Dry run only">
                                    <span>Dry run</span>
                                </label>
                            </div>
                            <div id="moderator-feedback" class="settings-feedback" aria-live="polite"></div>
                            <div class="settings-feedback" id="decay-status" aria-live="polite"></div>
                            <div class="decay-report" id="decay-report" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
                <!-- End Settings View -->

            </div>
            <!-- End View Container -->
        </div>
    </div>

    <!-- Toast Stack -->
    <div id="toast-stack"></div>

    <!-- Notification Center -->
    <div id="notification-center" class="hidden" aria-hidden="true">
        <div class="notification-center-header">
            <div class="notification-center-title">Notifications</div>
            <div class="notification-center-actions">
                <button id="notification-mark-read" type="button">Mark all read</button>
                <button id="notification-clear-non-errors" type="button">Clear non-errors</button>
                <button id="notification-close" type="button">Close</button>
            </div>
        </div>
        <div class="notification-filters">
            <div class="notification-filter-group" id="notification-filter-levels">
                <span class="filter-label">Levels</span>
                <label><input type="checkbox" data-level="info" checked>Info</label>
                <label><input type="checkbox" data-level="success" checked>Success</label>
                <label><input type="checkbox" data-level="warning" checked>Warning</label>
                <label><input type="checkbox" data-level="error" checked>Error</label>
            </div>
            <div class="notification-filter-group" id="notification-filter-scopes">
                <span class="filter-label">Scopes</span>
                <label><input type="checkbox" data-scope="global" checked>Global</label>
                <label><input type="checkbox" data-scope="workbench" checked>Workbench</label>
                <label><input type="checkbox" data-scope="editor" checked>Editor</label>
                <label><input type="checkbox" data-scope="terminal" checked>Terminal</label>
                <label><input type="checkbox" data-scope="jobs" checked>Jobs</label>
            </div>
        </div>
        <div id="notification-list"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.5/split.min.js"></script>
    <script>
        // Load Monaco
        var require = { paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.nls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.js"></script>
    <script src="state.js"></script>
    <script src="api.js"></script>
    <script src="modals.js"></script>
    <script src="notifications.js"></script>
    <script src="app.js"></script>
</body>
</html>
